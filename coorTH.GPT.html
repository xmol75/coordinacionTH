<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Coordinaci√≥n - Trasplante Hep√°tico</title>

  <!-- React + Babel (igual que el original) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

  <style>
    body { margin:0; padding:0; font-family: -apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif; }
    .linklike { background:none; border:none; color:#2563EB; cursor:pointer; text-decoration:underline; padding:0; font:inherit; }
    .muted { color:#6B7280; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Carga Firebase (m√≥dulos) y expone en window -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendEmailVerification, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, updateDoc, onSnapshot,
      query, orderBy, addDoc, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // --- TU CONFIG (igual que el original) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCZBR8tHpvgNayebtJh-yESOfFvln9dr2E",
      authDomain: "coordinacionth-97c72.firebaseapp.com",
      projectId: "coordinacionth-97c72",
      storageBucket: "coordinacionth-97c72.firebasestorage.app",
      messagingSenderId: "598740168465",
      appId: "1:598740168465:web:2d5de8e28964274cf7a6b0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Exponer para el script Babel
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseAuthFunctions = {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      onAuthStateChanged,
      signOut
    };
    window.firebaseDbFunctions = {
      collection, doc, setDoc, updateDoc, onSnapshot,
      query, orderBy, addDoc, serverTimestamp, getDoc
    };

    window.dispatchEvent(new Event('firebaseReady'));
  </script>

  <!-- App React -->
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Utilidades
    const normalizeEmail = (e) => (e || "").trim().toLowerCase();
    const nowHHMM = () => {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return \`\${hh}:\${mm}\`;
    };

    const TransplantCoordination = () => {
      // --- Estado global / auth ---
      const [user, setUser] = useState(null);
      const [firebaseReady, setFirebaseReady] = useState(false);
      const [initialLoading, setInitialLoading] = useState(true);

      // --- Auth form ---
      const [authMode, setAuthMode] = useState("login");
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [confirmPassword, setConfirmPassword] = useState("");
      const [displayName, setDisplayName] = useState("");
      const [authError, setAuthError] = useState("");
      const [authSuccess, setAuthSuccess] = useState("");
      const [formLoading, setFormLoading] = useState(false);
      const [showPassword, setShowPassword] = useState(false);
      const [showConfirmPassword, setShowConfirmPassword] = useState(false);

      // --- App ---
      const [activeCoordination, setActiveCoordination] = useState(null);
      const [events, setEvents] = useState([]);
      const [chatMessages, setChatMessages] = useState([]);
      const [editingEvent, setEditingEvent] = useState(null);
      const [chatMessage, setChatMessage] = useState("");
      const [formData, setFormData] = useState({ time:"", responsible:"", comments:"" });
      const chatEndRef = useRef(null);

      const defaultEvents = [
        { id:1, name:"Hora de donante en quir√≥fano", status:"pending", time:"", responsible:"", comments:"", icon:"üè•" },
        { id:2, name:"Confirmaci√≥n de donante en quir√≥fano", status:"pending", time:"", responsible:"", comments:"", icon:"‚úÖ" },
        { id:3, name:"Inicio de la extracci√≥n", status:"pending", time:"", responsible:"", comments:"", icon:"üî¨" },
        { id:4, name:"Valoraci√≥n inicial del √≥rgano", status:"pending", time:"", responsible:"", comments:"", icon:"üîç" },
        { id:5, name:"Inicio de la perfusi√≥n fr√≠a", status:"pending", time:"", responsible:"", comments:"", icon:"‚ùÑÔ∏è" },
        { id:6, name:"Validez del √≥rgano", status:"pending", time:"", responsible:"", comments:"", icon:"‚úì" },
        { id:7, name:"√ìrgano en nevera", status:"pending", time:"", responsible:"", comments:"", icon:"üßä" },
        { id:8, name:"Hora de receptor en quir√≥fano", status:"pending", time:"", responsible:"", comments:"", icon:"üè•" },
        { id:9, name:"Confirmaci√≥n de receptor en quir√≥fano", status:"pending", time:"", responsible:"", comments:"", icon:"‚úÖ" },
        { id:10, name:"Hora 0", status:"pending", time:"", responsible:"", comments:"", icon:"‚è∞" },
        { id:11, name:"Inicio del implante", status:"pending", time:"", responsible:"", comments:"", icon:"‚öïÔ∏è" }
      ];

      // Firebase listo
      useEffect(() => {
        const onReady = () => setFirebaseReady(true);
        window.addEventListener("firebaseReady", onReady);
        return () => window.removeEventListener("firebaseReady", onReady);
      }, []);

      // Listener de auth
      useEffect(() => {
        if (!firebaseReady || !window.firebaseAuth) { setInitialLoading(false); return; }
        const unsub = window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, (currentUser) => {
          setUser(currentUser);
          if (currentUser?.displayName) setDisplayName(currentUser.displayName);
          setInitialLoading(false);
        });
        return () => unsub();
      }, [firebaseReady]);

      // Firestore listeners (solo si autenticado)
      useEffect(() => {
        if (!firebaseReady || !user) return;
        const coordinationRef = window.firebaseDbFunctions.doc(window.firebaseDb, "coordination", "active");
        const unsub = window.firebaseDbFunctions.onSnapshot(coordinationRef, (docSnap) => {
          setActiveCoordination(docSnap.exists() ? docSnap.data() : null);
        });
        return () => unsub();
      }, [firebaseReady, user]);

      useEffect(() => {
        if (!firebaseReady || !user || !activeCoordination) return;
        const eventsRef = window.firebaseDbFunctions.collection(window.firebaseDb, "coordination", "active", "events");
        const unsub = window.firebaseDbFunctions.onSnapshot(eventsRef, (snapshot) => {
          const arr = [];
          snapshot.forEach((d) => arr.push({ ...d.data(), firestoreId: d.id }));
          arr.sort((a,b) => a.id - b.id);
          setEvents(arr);
        });
        return () => unsub();
      }, [firebaseReady, user, activeCoordination]);

      useEffect(() => {
        if (!firebaseReady || !user || !activeCoordination) return;
        const messagesRef = window.firebaseDbFunctions.collection(window.firebaseDb, "coordination", "active", "messages");
        const q = window.firebaseDbFunctions.query(messagesRef, window.firebaseDbFunctions.orderBy("timestamp","asc"));
        const unsub = window.firebaseDbFunctions.onSnapshot(q, (snapshot) => {
          const arr = [];
          snapshot.forEach((d) => {
            const data = d.data();
            arr.push({
              id: d.id,
              ...data,
              timestamp: data.timestamp ? new Date(data.timestamp.seconds*1000).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}) : ""
            });
          });
          setChatMessages(arr);
        });
        return () => unsub();
      }, [firebaseReady, user, activeCoordination]);

      useEffect(() => { chatEndRef.current?.scrollIntoView({behavior:"smooth"}); }, [chatMessages]);

      // Validaciones
      const validatePassword = (pass) => {
        const p = pass || "";
        return (
          p.length >= 8 &&
          /[A-Z]/.test(p) &&
          /[a-z]/.test(p) &&
          /[0-9]/.test(p) &&
          /[!@#$%^&*(),.?":{}|<>]/.test(p)
        );
      };
      const validateEmail = (e) => normalizeEmail(e).endsWith("@ssib.es");

      // Acciones Auth
      const handleRegister = async (e) => {
        e.preventDefault();
        setAuthError(""); setAuthSuccess("");
        const em = normalizeEmail(email);

        if (!validateEmail(em)) { setAuthError("El correo debe ser corporativo (@ssib.es)."); return; }
        if (!validatePassword(password)) { setAuthError("La contrase√±a no cumple los requisitos de seguridad."); return; }
        if (password !== confirmPassword) { setAuthError("Las contrase√±as no coinciden."); return; }

        setFormLoading(true);
        try {
          const cred = await window.firebaseAuthFunctions.createUserWithEmailAndPassword(window.firebaseAuth, em, password);
          await window.firebaseAuthFunctions.sendEmailVerification(cred.user);
          setAuthSuccess(\`‚úÖ Registro exitoso. Hemos enviado verificaci√≥n a \${em}. Revisa tu bandeja (y spam).\`);
          setAuthMode("login"); setEmail(""); setPassword(""); setConfirmPassword("");
        } catch (error) {
          if (error.code === "auth/email-already-in-use") setAuthError("Este correo ya est√° registrado.");
          else if (error.code === "auth/unauthorized-domain") setAuthError("Dominio no autorizado. A√±ade tu dominio (p. ej., localhost) en Firebase > Authentication > Authorized domains.");
          else setAuthError("Error al registrar: " + (error?.message || error));
        } finally { setFormLoading(false); }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setAuthError(""); setAuthSuccess("");
        const em = normalizeEmail(email);
        if (!validateEmail(em)) { setAuthError("El correo debe ser corporativo (@ssib.es)."); return; }

        setFormLoading(true);
        try {
          const cred = await window.firebaseAuthFunctions.signInWithEmailAndPassword(window.firebaseAuth, em, password);
          if (!cred.user.emailVerified) {
            setAuthError("‚ö†Ô∏è Debes verificar tu correo electr√≥nico antes de iniciar sesi√≥n.");
            // No cierro sesi√≥n: permito pulsar 'Reenviar verificaci√≥n'
          } else {
            setAuthSuccess("‚úÖ Inicio de sesi√≥n exitoso.");
            setEmail(""); setPassword("");
          }
        } catch (error) {
          if (error.code === "auth/wrong-password" || error.code === "auth/user-not-found")
            setAuthError("‚ùå Correo o contrase√±a incorrectos.");
          else if (error.code === "auth/invalid-credential")
            setAuthError("‚ùå Credenciales inv√°lidas. Verifica correo y contrase√±a.");
          else if (error.code === "auth/too-many-requests")
            setAuthError("‚ùå Demasiados intentos fallidos. Espera unos minutos e int√©ntalo de nuevo.");
          else if (error.code === "auth/unauthorized-domain")
            setAuthError("‚ùå Dominio no autorizado. A√±ade localhost/127.0.0.1 en Firebase > Authentication > Authorized domains.");
          else
            setAuthError("‚ùå Error al iniciar sesi√≥n: " + (error?.message || error));
        } finally { setFormLoading(false); }
      };

      const resendVerification = async () => {
        try {
          const u = window.firebaseAuth.currentUser;
          if (u) {
            await window.firebaseAuthFunctions.sendEmailVerification(u);
            setAuthSuccess("‚úâÔ∏è Verificaci√≥n reenviada. Revisa tu bandeja (y spam).");
            setAuthError("");
          } else {
            setAuthError("Inicia sesi√≥n con tu correo y contrase√±a para reenviar la verificaci√≥n.");
          }
        } catch (e) {
          setAuthError("No se pudo reenviar la verificaci√≥n: " + (e?.message || e));
        }
      };

      const handleLogout = async () => {
        try { await window.firebaseAuthFunctions.signOut(window.firebaseAuth); }
        catch (e) { console.error("Logout error:", e); }
      };

      // App actions
      const startNewCoordination = async () => {
        try {
          const coordinationRef = window.firebaseDbFunctions.doc(window.firebaseDb,"coordination","active");
          await window.firebaseDbFunctions.setDoc(coordinationRef, {
            startedAt: window.firebaseDbFunctions.serverTimestamp(),
            startedBy: user?.email || "unknown",
            active: true
          });
          const eventsRef = window.firebaseDbFunctions.collection(window.firebaseDb,"coordination","active","events");
          for (const ev of defaultEvents) {
            await window.firebaseDbFunctions.setDoc(
              window.firebaseDbFunctions.doc(eventsRef, \`event_\${ev.id}\`), ev
            );
          }
          const messagesRef = window.firebaseDbFunctions.collection(window.firebaseDb,"coordination","active","messages");
          await window.firebaseDbFunctions.addDoc(messagesRef, {
            user: "Sistema",
            message: \`üöÄ Coordinaci√≥n iniciada por \${user?.email}\`,
            timestamp: window.firebaseDbFunctions.serverTimestamp(),
            isSystem: true
          });
        } catch (e) {
          alert("Error al iniciar coordinaci√≥n: " + (e?.message || e));
        }
      };

      const openEventModal = (ev) => {
        setEditingEvent(ev);
        setFormData({
          time: ev.time || nowHHMM(),
          responsible: ev.responsible || displayName || user?.email || "",
          comments: ev.comments || ""
        });
      };

      const saveEvent = async () => {
        try {
          const ref = window.firebaseDbFunctions.doc(
            window.firebaseDb, "coordination", "active", "events", editingEvent.firestoreId
          );
          await window.firebaseDbFunctions.updateDoc(ref, { ...formData, status:"completed" });

          const messagesRef = window.firebaseDbFunctions.collection(window.firebaseDb,"coordination","active","messages");
          await window.firebaseDbFunctions.addDoc(messagesRef, {
            user: formData.responsible,
            message: \`‚úì \${editingEvent.name} completado\`,
            timestamp: window.firebaseDbFunctions.serverTimestamp(),
            isSystem: true
          });
          setEditingEvent(null);
        } catch (e) {
          alert("Error al guardar: " + (e?.message || e));
        }
      };

      const sendChatMessage = async () => {
        const msg = (chatMessage || "").trim();
        if (!msg) return;
        try {
          const messagesRef = window.firebaseDbFunctions.collection(window.firebaseDb,"coordination","active","messages");
          await window.firebaseDbFunctions.addDoc(messagesRef, {
            user: displayName || user?.email || "Usuario",
            message: msg,
            timestamp: window.firebaseDbFunctions.serverTimestamp(),
            isSystem: false
          });
          setChatMessage("");
        } catch (e) { console.error("Error chat:", e); }
      };

      // --- Renders ---
      if (initialLoading) {
        return (
          <div style={{minHeight:"100vh",background:"linear-gradient(to bottom right,#EFF6FF,#E0E7FF)",display:"flex",alignItems:"center",justifyContent:"center"}}>
            <div style={{textAlign:"center"}}>
              <div style={{fontSize:"3rem",marginBottom:"1rem"}}>üè•</div>
              <p className="muted" style={{fontSize:"1.125rem"}}>Cargando‚Ä¶</p>
            </div>
          </div>
        );
      }

      // Pantalla de autenticaci√≥n
      if (!user || !user.emailVerified) {
        return (
          <div style={{minHeight:"100vh",background:"linear-gradient(to bottom right,#EFF6FF,#E0E7FF)",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"}}>
            <div style={{background:"white",borderRadius:"0.5rem",boxShadow:"0 20px 25px -5px rgba(0,0,0,.1)",maxWidth:"28rem",width:"100%"}}>
              <div style={{padding:"2rem"}}>
                <h1 style={{fontSize:"1.875rem",fontWeight:"bold",textAlign:"center",marginBottom:".5rem"}}>üè• Coordinaci√≥n Trasplante Hep√°tico</h1>
                <p style={{textAlign:"center",color:"#6B7280",marginBottom:"2rem"}}>
                  {new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
                </p>

                <div style={{display:"flex",gap:".5rem",marginBottom:"1.5rem"}}>
                  <button onClick={()=>{setAuthMode("login");setAuthError("");setAuthSuccess("");}}
                    style={{flex:1,padding:".75rem",background: authMode==="login" ? "#3B82F6" : "#F3F4F6",
                            color: authMode==="login" ? "white" : "#374151", border:"none", borderRadius:".5rem", fontWeight:600,cursor:"pointer"}}>
                    Iniciar Sesi√≥n
                  </button>
                  <button onClick={()=>{setAuthMode("register");setAuthError("");setAuthSuccess("");}}
                    style={{flex:1,padding:".75rem",background: authMode==="register" ? "#3B82F6" : "#F3F4F6",
                            color: authMode==="register" ? "white" : "#374151", border:"none", borderRadius:".5rem", fontWeight:600,cursor:"pointer"}}>
                    Registrarse
                  </button>
                </div>

                {authError && (
                  <div style={{padding:".75rem",background:"#FEE2E2",border:"1px solid #EF4444",borderRadius:".5rem",color:"#991B1B",marginBottom:"1rem",fontSize:".875rem"}}>
                    <div style={{marginBottom:".25rem"}}>{authError}</div>
                    {(!user || !user.emailVerified) && (
                      <div>
                        <button className="linklike" onClick={resendVerification}>Reenviar verificaci√≥n</button>
                      </div>
                    )}
                  </div>
                )}

                {authSuccess && (
                  <div style={{padding:".75rem",background:"#D1FAE5",border:"1px solid #10B981",borderRadius:".5rem",color:"#065F46",marginBottom:"1rem",fontSize:".875rem"}}>
                    {authSuccess}
                  </div>
                )}

                <form onSubmit={authMode==="login" ? handleLogin : handleRegister}>
                  <div style={{marginBottom:"1rem"}}>
                    <label style={{display:"block",fontSize:".875rem",fontWeight:600,marginBottom:".5rem"}}>Correo corporativo (@ssib.es)</label>
                    <input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} placeholder="usuario@ssib.es" required
                      style={{width:"100%",padding:".75rem",border:"1px solid #D1D5DB",borderRadius:".5rem",fontSize:"1rem",boxSizing:"border-box"}}/>
                  </div>

                  <div style={{marginBottom:"1rem"}}>
                    <label style={{display:"block",fontSize:".875rem",fontWeight:600,marginBottom:".5rem"}}>Contrase√±a</label>
                    <div style={{position:"relative"}}>
                      <input type={showPassword?"text":"password"} value={password} onChange={(e)=>setPassword(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
                        style={{width:"100%",padding:".75rem",paddingRight:"3rem",border:"1px solid #D1D5DB",borderRadius:".5rem",fontSize:"1rem",boxSizing:"border-box"}}/>
                      <button type="button" onClick={()=>setShowPassword(!showPassword)}
                        style={{position:"absolute",right:".75rem",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",fontSize:"1.25rem",padding:".25rem",color:"#6B7280"}}>
                        {showPassword ? "üôà" : "üëÅÔ∏è"}
                      </button>
                    </div>
                    {authMode==="register" && (
                      <div style={{fontSize:".75rem",color:"#6B7280",marginTop:".5rem",lineHeight:1.6}}>
                        <div>‚Ä¢ M√≠nimo 8 caracteres</div><div>‚Ä¢ 1 may√∫scula y 1 min√∫scula</div><div>‚Ä¢ 1 n√∫mero y 1 s√≠mbolo</div>
                      </div>
                    )}
                  </div>

                  {authMode==="register" && (
                    <div style={{marginBottom:"1rem"}}>
                      <label style={{display:"block",fontSize:".875rem",fontWeight:600,marginBottom:".5rem"}}>Confirmar contrase√±a</label>
                      <div style={{position:"relative"}}>
                        <input type={showConfirmPassword?"text":"password"} value={confirmPassword} onChange={(e)=>setConfirmPassword(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
                          style={{width:"100%",padding:".75rem",paddingRight:"3rem",border:"1px solid #D1D5DB",borderRadius:".5rem",fontSize:"1rem",boxSizing:"border-box"}}/>
                        <button type="button" onClick={()=>setShowConfirmPassword(!showConfirmPassword)}
                          style={{position:"absolute",right:".75rem",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",fontSize:"1.25rem",padding:".25rem",color:"#6B7280"}}>
                          {showConfirmPassword ? "üôà" : "üëÅÔ∏è"}
                        </button>
                      </div>
                    </div>
                  )}

                  <button type="submit" disabled={formLoading}
                    style={{width:"100%",padding:".75rem",background: formLoading ? "#9CA3AF" : "#3B82F6",
                            color:"white",border:"none",borderRadius:".5rem",fontWeight:600,cursor: formLoading ? "not-allowed":"pointer",fontSize:"1rem"}}>
                    {formLoading ? "Procesando‚Ä¶" : (authMode==="login" ? "Iniciar Sesi√≥n" : "Registrarse")}
                  </button>
                </form>
              </div>
            </div>
          </div>
        );
      }

      // Sin coordinaci√≥n activa
      if (!activeCoordination) {
        return (
          <div style={{minHeight:"100vh",background:"linear-gradient(to bottom right,#EFF6FF,#E0E7FF)"}}>
            <div style={{background:"white",boxShadow:"0 4px 6px -1px rgba(0,0,0,.1)",borderBottom:"4px solid #3B82F6"}}>
              <div style={{maxWidth:"80rem",margin:"0 auto",padding:"1.5rem"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <h1 style={{fontSize:"1.875rem",fontWeight:"bold",marginBottom:".25rem"}}>üè• Coordinaci√≥n Trasplante Hep√°tico</h1>
                    <p className="muted" style={{fontSize:".875rem"}}>
                      {new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
                    </p>
                  </div>
                  <div style={{textAlign:"right"}}>
                    <p style={{fontSize:".875rem",color:"#374151",marginBottom:".5rem"}}>{displayName || user?.email}</p>
                    <button onClick={handleLogout}
                      style={{padding:".5rem 1rem",background:"#EF4444",color:"white",border:"none",borderRadius:".375rem",fontWeight:600,cursor:"pointer",fontSize:".875rem"}}>
                      Cerrar Sesi√≥n
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"calc(100vh - 150px)"}}>
              <div style={{textAlign:"center",padding:"2rem"}}>
                <div style={{fontSize:"4rem",marginBottom:"1rem"}}>üè•</div>
                <h2 style={{fontSize:"2rem",fontWeight:"bold",marginBottom:"1rem",color:"#374151"}}>No hay coordinaci√≥n activa</h2>
                <p className="muted" style={{marginBottom:"2rem",fontSize:"1.125rem"}}>Inicia una nueva coordinaci√≥n de trasplante para comenzar</p>
                <button onClick={startNewCoordination}
                  style={{padding:"1rem 2rem",background:"#10B981",color:"white",border:"none",borderRadius:".5rem",fontWeight:700,cursor:"pointer",fontSize:"1.125rem",
                          boxShadow:"0 4px 6px -1px rgba(0,0,0,.1)"}}>
                  üöÄ Iniciar Coordinaci√≥n de Trasplante
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Pantalla principal
      return (
        <div style={{minHeight:"100vh",background:"linear-gradient(to bottom right,#EFF6FF,#E0E7FF)"}}>
          <div style={{background:"white",boxShadow:"0 4px 6px -1px rgba(0,0,0,.1)",borderBottom:"4px solid #3B82F6"}}>
            <div style={{maxWidth:"80rem",margin:"0 auto",padding:"1.5rem"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div>
                  <h1 style={{fontSize:"1.875rem",fontWeight:"bold",marginBottom:".25rem"}}>üè• Coordinaci√≥n Trasplante Hep√°tico</h1>
                  <p className="muted" style={{fontSize:".875rem"}}>
                    {new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
                  </p>
                </div>
                <div style={{textAlign:"right"}}>
                  <p style={{fontSize:".875rem",color:"#374151",marginBottom:".5rem"}}>{displayName || user?.email}</p>
                  <button onClick={handleLogout}
                    style={{padding:".5rem 1rem",background:"#EF4444",color:"white",border:"none",borderRadius:".375rem",fontWeight:600,cursor:"pointer",fontSize:".875rem"}}>
                    Cerrar Sesi√≥n
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div style={{maxWidth:"80rem",margin:"0 auto",padding:"1.5rem"}}>
            <div style={{display:"grid",gridTemplateColumns:"2fr 1fr",gap:"1.5rem"}}>
              <div>
                <div style={{background:"white",borderRadius:".5rem",boxShadow:"0 4px 6px -1px rgba(0,0,0,.1)",padding:"1.5rem"}}>
                  <h2 style={{fontSize:"1.5rem",fontWeight:"bold",marginBottom:"1.5rem"}}>‚è±Ô∏è Timeline de Eventos</h2>
                  <div style={{display:"flex",flexDirection:"column",gap:".75rem"}}>
                    {events.map((ev, idx) => (
                      <div key={ev.id} style={{position:"relative"}}>
                        {idx < events.length-1 && (
                          <div style={{position:"absolute",left:"1.5rem",top:"3.5rem",width:"2px",height:"2rem",
                            background: ev.status==="completed" ? "#10B981" : "#D1D5DB"}}/>
                        )}
                        <div onClick={() => ev.status!=="completed" && openEventModal(ev)}
                          style={{display:"flex",gap:"1rem",padding:"1rem",borderRadius:".5rem",
                                  border:\`2px solid \${ev.status==="completed" ? "#10B981" : "#D1D5DB"}\`,
                                  background: ev.status==="completed" ? "#F0FDF4" : "#F9FAFB",
                                  cursor: ev.status!=="completed" ? "pointer" : "default", transition:"all .2s"}}>
                          <div style={{width:"3rem",height:"3rem",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",
                                       fontSize:"1.5rem",background: ev.status==="completed" ? "#10B981" : "#D1D5DB", color:"white",flexShrink:0}}>
                            {ev.status==="completed" ? "‚úì" : ev.icon}
                          </div>
                          <div style={{flex:1}}>
                            <h3 style={{fontWeight:"bold",marginBottom:".25rem"}}>{ev.name}</h3>
                            {ev.status==="completed" ? (
                              <div style={{fontSize:".875rem"}}>
                                <p style={{color:"#374151"}}><strong>Hora:</strong> {ev.time} | <strong>Responsable:</strong> {ev.responsible}</p>
                                {ev.comments && <p style={{color:"#6B7280",fontStyle:"italic",marginTop:".25rem"}}>{ev.comments}</p>}
                              </div>
                            ) : (
                              <p className="muted" style={{fontSize:".875rem"}}>Click para registrar este evento</p>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div>
                <div style={{background:"white",borderRadius:".5rem",boxShadow:"0 4px 6px -1px rgba(0,0,0,.1)",height:"calc(100vh - 250px)",display:"flex",flexDirection:"column"}}>
                  <div style={{padding:"1rem",borderBottom:"1px solid #E5E7EB"}}>
                    <h2 style={{fontSize:"1.25rem",fontWeight:"bold"}}>üí¨ Chat de Coordinaci√≥n</h2>
                    <p className="muted" style={{fontSize:".75rem"}}>Comunicaci√≥n entre equipos</p>
                  </div>
                  <div style={{flex:1,overflowY:"auto",padding:"1rem",display:"flex",flexDirection:"column",gap:".75rem"}}>
                    {chatMessages.length===0 ? (
                      <div style={{textAlign:"center",color:"#9CA3AF",padding:"2rem"}}><p style={{fontSize:".875rem"}}>No hay mensajes a√∫n</p></div>
                    ) : (
                      chatMessages.map((m) => (
                        <div key={m.id} style={{padding:".75rem",borderRadius:".5rem",background: m.isSystem ? "#EFF6FF" : "#F3F4F6",
                                                 border: m.isSystem ? "1px solid #BFDBFE" : "none"}}>
                          <div style={{display:"flex",justifyContent:"space-between",marginBottom:".25rem"}}>
                            <span style={{fontWeight:600,fontSize:".875rem"}}>{m.user}</span>
                            <span className="muted" style={{fontSize:".75rem"}}>{m.timestamp}</span>
                          </div>
                          <p style={{fontSize:".875rem"}}>{m.message}</p>
                        </div>
                      ))
                    )}
                    <div ref={chatEndRef} />
                  </div>
                  <div style={{padding:"1rem",borderTop:"1px solid #E5E7EB"}}>
                    <div style={{display:"flex",gap:".5rem"}}>
                      <input type="text" value={chatMessage} onChange={(e)=>setChatMessage(e.target.value)}
                        onKeyDown={(e)=>{ if(e.key==="Enter") sendChatMessage(); }}
                        placeholder="Escribe un mensaje‚Ä¶"
                        style={{flex:1,padding:".5rem",border:"1px solid #D1D5DB",borderRadius:".5rem",fontSize:".875rem"}} />
                      <button onClick={sendChatMessage} disabled={!chatMessage.trim()}
                        style={{background: chatMessage.trim()? "#3B82F6":"#D1D5DB", color:"white", padding:".5rem 1rem",
                                borderRadius:".5rem", border:"none", cursor: chatMessage.trim()? "pointer":"not-allowed", fontWeight:600}}>
                        Enviar
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          {editingEvent && (
            <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.5)",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem",zIndex:50}}>
              <div style={{background:"white",borderRadius:".5rem",maxWidth:"28rem",width:"100%",boxShadow:"0 20px 25px -5px rgba(0,0,0,.1)"}}>
                <div style={{padding:"1.5rem",borderBottom:"1px solid #E5E7EB"}}>
                  <h3 style={{fontSize:"1.25rem",fontWeight:"bold"}}>{editingEvent.icon} Registrar Evento</h3>
                </div>
                <div style={{padding:"1.5rem",display:"flex",flexDirection:"column",gap:"1rem"}}>
                  <div>
                    <label style={{display:"block",fontSize:".875rem",fontWeight:600,marginBottom:".5rem"}}>Evento</label>
                    <p style={{background:"#F9FAFB",padding:".75rem",borderRadius:".5rem"}}>{editingEvent.name}</p>
                  </div>
                  <div>
                    <label style={{display:"block",fontSize:".875rem",fontWeight:600,marginBottom:".5rem"}}>Hora</label>
                    <input type="time" value={formData.time} onChange={(e)=>setFormData({...formData,time:e.target.value})}
                      style={{width:"100%",padding:".75rem",border:"1px solid #D1D5DB",borderRadius:".5rem",boxSizing:"border-box"}}/>
                  </div>
                  <div>
                    <label style={{display:"block",fontSize:".875rem",fontWeight:600,marginBottom:".5rem"}}>Responsable (tu email o nombre)</label>
                    <input type="text" value={formData.responsible} onChange={(e)=>setFormData({...formData,responsible:e.target.value})}
                      placeholder={user?.email || "Tu nombre"}
                      style={{width:"100%",padding:".75rem",border:"1px solid #D1D5DB",borderRadius:".5rem",boxSizing:"border-box"}}/>
                  </div>
                  <div>
                    <label style={{display:"block",fontSize:".875rem",fontWeight:600,marginBottom:".5rem"}}>Comentarios (opcional)</label>
                    <textarea rows="3" value={formData.comments} onChange={(e)=>setFormData({...formData,comments:e.target.value})}
                      placeholder="A√±ade observaciones relevantes‚Ä¶"
                      style={{width:"100%",padding:".75rem",border:"1px solid #D1D5DB",borderRadius:".5rem",resize:"vertical",boxSizing:"border-box"}}/>
                  </div>
                </div>
                <div style={{padding:"1.5rem",borderTop:"1px solid #E5E7EB",display:"flex",gap:".75rem"}}>
                  <button onClick={()=>setEditingEvent(null)}
                    style={{flex:1,padding:".75rem",background:"#E5E7EB",color:"#374151",border:"none",borderRadius:".5rem",fontWeight:600,cursor:"pointer"}}>
                    Cancelar
                  </button>
                  <button onClick={saveEvent}
                    style={{flex:1,padding:".75rem",background:"#10B981",color:"white",border:"none",borderRadius:".5rem",fontWeight:600,cursor:"pointer"}}>
                    Guardar
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<TransplantCoordination />);
  </script>
</body>
</html>